---
title: "Night_survey_data_ad"
author: "Tori Burt"
date: "2024-01-09"
output: html_document
---

```{r loading packages}

library(lme4) #run lme4 before lmerTest 
library(lmerTest)
library(glmmTMB)
library(tidyverse)
library(car)
library(DHARMa)
library(effects)
library(ggeffects)
library(conflicted)
library(data.table)
library(effects)
library(lubridate)

conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("yday", "lubridate")

```

```{r tailoring data to analysis}

#load data
load("Data_Night_survey_ad.Rda")

tb1_ad <- tb1_ad %>%
  drop_na(Total_ad_LESP_per_night)

#categorize wind to onshore and offshore based on tangent to coastline
tb1_ad_wind <- filter(tb1_ad, Wind_Speed != "NA") %>%
  mutate(Wind_Direction = as.numeric(Wind_Direction) * 10) %>%
  mutate(OnOffShore = ifelse(Wind_Direction < 166, "onshore", ifelse(Wind_Direction > 346, "onshore", "offshore")))
tb1_ad_wind$OnOffShore <- as.factor(tb1_ad_wind$OnOffShore)

#select for columns of interest
tb2_ad <- select(tb1_ad_wind, Date, Plant_lights, Total_ad_LESP_per_night, Fog_Cat, CloudCover_Cat, yDate, Lunar, Year, Wind_Speed, OnOffShore) %>%
  drop_na(Date, Plant_lights, Total_ad_LESP_per_night, Fog_Cat, CloudCover_Cat, yDate, Lunar, Year, Wind_Speed, OnOffShore) %>%
  filter(CloudCover_Cat != "NA") 

```

```{r analyzing data}

#check outliers
boxplot(tb2_ad$Total_ad_LESP_per_night, ylab = "Number of Stranded Birds", xlab = "")

#no significant outliers

#visualize data
hist(tb2_ad$Total_ad_LESP_per_night, breaks = 31)

#lights boxplots
boxplot(tb2_ad$Total_ad_LESP_per_night ~ tb2_ad$Plant_lights, ylab = "Number of Stranded Birds", xlab = "")

#check for covariance
my_vars <- tb2_ad[, c("yDate", "Lunar", "Wind_Speed")]
cor(my_vars)
plot(my_vars)

#lightsmod 1 - linear - poor fit
mod1_tb <- lm(Total_ad_LESP_per_night ~ Lunar + yDate + Plant_lights + Wind_Speed + OnOffShore + CloudCover_Cat + Year, data = tb2_ad)

#testing vif
vif(mod1_tb)

#testing assumptions
plot(mod1_tb, ask = FALSE)

#assumptions are violated

#lightsmod2 - poisson distribution - poor fit
mod2_tb <- glmmTMB(Total_ad_LESP_per_night ~ Lunar + yDate + Plant_lights + Wind_Speed + OnOffShore + CloudCover_Cat + Year, data = tb2_ad, family = poisson(link = "log"))

#testing assumptions
assumptions <- simulateResiduals(fittedModel = mod2_tb, plot = TRUE, refit = FALSE)

#assumptions violated

summary(mod2_tb)

#test zero inflation - not significant
testZeroInflation(assumptions)

#lightsmod3 - negative binomial distribution - BEST FIT
tb2_ad <- within(tb2_ad, Plant_lights <- relevel(Plant_lights, ref = "On"))
mod3_tb <- glmmTMB(Total_ad_LESP_per_night ~ Lunar + yDate + Plant_lights + OnOffShore + Year + Wind_Speed + CloudCover_Cat, data = tb2_ad, family = nbinom1(link = "log"), dispformula = ~Wind_Speed)

#testing assumptions
assumptions <- simulateResiduals(fittedModel = mod3_tb, plot = TRUE, refit = FALSE)

#check each variable
plotResiduals(form = tb2_ad$Plant_lights, simulationOutput = assumptions, asFactor = T)
plotResiduals(form = tb2_ad$yDate, simulationOutput = assumptions)
plotResiduals(form = tb2_ad$Lunar, simulationOutput = assumptions)
plotResiduals(form = tb2_ad$Year, simulationOutput = assumptions, asFactor = T)
plotResiduals(form = tb2_ad$CloudCover_Cat, simulationOutput = assumptions, asFactor = T)
plotResiduals(form = tb2_ad$OnOffShore, simulationOutput = assumptions, asFactor = T)
plotResiduals(form = tb2_ad$Wind_Speed, simulationOutput = assumptions)

#testing dispersion - not significant
testDispersion(mod3_tb)

#results
Anova(mod3_tb)
summary(mod3_tb)
ae <- allEffects(mod3_tb)
plot(ae)
confint(mod3_tb, parm = NULL, level = 0.95, method = "wald")

```

```{r figure construction}

#effects plot
effect <- ggpredict(mod3_tb, terms = "Plant_lights")
lights_df_ad <- as.data.frame(effect)
png(filename = "Figures/effect_light_2022_NS_ad_TVB.png", width = 2000, height = 1538, res = 600)
plt <- ggplot(data = lights_df_ad, aes(x = x, ymin = 0, ymax = 20)) +
  theme(axis.title = element_text(size = 9)) +
  geom_line(aes(y = predicted, group = 2)) +
  geom_point(aes(y = predicted, x = x)) +
  labs(x="Lighting Condition", y="Predicted Counts of Stranded Birds") +
  theme(panel.background = element_rect(fill = 'white', colour = 'black')) +
  geom_text(x = 1, y = 4.5, label = "3.07", size = 3) +
  geom_text(x = 2, y = 1.8, label = "0.37", size = 3)
plt + geom_ribbon(aes(x = 1:length(x), ymin = conf.low, ymax = conf.high), alpha =.2) 
dev.off()

```
